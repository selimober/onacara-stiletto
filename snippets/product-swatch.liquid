{% liquid
  comment
    Renders a swatch.

    Required parameters:
      - context: { String } Where the swatch is being rendered (the swatch markup can vary depending on the context). Can be:
        - 'product-page'
        - 'product-item'
      - prod: { Object } The product that the swatch is associated with.
      - forloop_index: { Number } Taken from the option looping through values.
      - option_name: { String } The option name whose values should display as swatches. Is downcased and has newlines stripped.
      - option_index: { Number } The index of the option (1-based) in the list of product options. Used to find the associated variant image if variant image swatches are enabled.
      - option_value: { String } The current option value being rendered as a swatch.

    Optional parameters:
      - swatch_size: { Number } The width of the swatch.
      - swatch_image_width: { Number } The width of the swatch image source.
      - selected_value: { String } The currently selected option value. Only applies to variant picker swatches to determine whether the current swatch is selected.
  endcomment

  assign file_extension = '.png'
  assign option_index0 = option_index | minus: 1

  capture swatch_html
    assign option = option_value | downcase | strip

    assign swatch_img = ''

    if settings.use_variant_image_swatches
      assign variant_swatch_image = blank
      for variant in prod.variants
        if variant.options[option_index0] == option_value and variant.image
          assign variant_swatch_image = variant.image
          break
        endif
      endfor
    endif

    if variant_swatch_image != blank
      assign swatch_img = variant_swatch_image
    elsif option_value.swatch and option_value.swatch.image
      assign swatch_img = option_value.swatch.image
    else
      assign custom_swatch_image = option_value | handle | append: file_extension
      if images[custom_swatch_image] != blank
        assign swatch_img = images[custom_swatch_image]
      endif
    endif

    if swatch_img != blank
      echo swatch_img | image_url: width: swatch_image_width | image_tag: alt: option_value, loading: 'lazy', role: 'presentation'
    endif

    # color
    if option_value.swatch and option_value.swatch.color
      assign background_color_value = option_value.swatch.color
    elsif custom_color_key_map contains option
      for color_name in custom_color_key_map
        if color_name == option
          assign background_color_value = custom_color_value_map[forloop.index0]
          break
        endif
      endfor
    else
      assign background_color_value = option_value | downcase | replace: ' ', ''
    endif

    assign swatch_background_style = 'background-color: [[bcv]];' | replace: '[[bcv]]', background_color_value
  endcapture
%}

{% case context %}
  {% when 'product-item' %}
    <li
      class="product-swatches-options__item product-swatches-options__item--swatch"
      data-swatch-shape="{{ settings.swatch_shape }}"
      style="{{ swatch_background_style }}"
      aria-label="{{ option_name }} {{ option_value }}"
    >
      {{- swatch_html -}}
    </li>
  {% else %}
    <button
      type="button"
      data-button
      data-label="{{ option_value | url_encode }}"
      aria-label="{{ option_value | replace: '"', "'" }}"
      data-option-value="{{ option_value | escape }}"
      data-option-handle="{{ option_value | handleize }}--{{ forloop_index }}"
      data-shape="{{ settings.swatch_shape }}"
      data-size="{{ swatch_size }}"
      class="
        product__color-swatch
        {% if selected_value == option_value %}
          selected
        {% endif %}
        {% if settings.enable_dynamic_product_options %}
          dynamic-variant-button
        {% endif %}
      "
      style="{{ swatch_background_style }}"
    >
      {{- swatch_html -}}
    </button>
{% endcase %}
